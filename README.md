# ConfoTS

**ConfoTS** is a Python-based automated workflow for reaction barrier estimation and transition state (TS) identification using multiple conformers.
It builds upon [ACCeL](https://github.com/kfchem/accel), which provides flexible support for handling ensembles of molecular conformers, to enable end-to-end TS searches, energy evaluations, and barrier diagram generation.

---

## 🧬 Key Features

* Accepts reaction definition files (`.rxn`) as input and automatically parses, separates, and maps reactant–product structures and atoms
* Automated transition state searches using NEB (nudged elastic band) for conformer pairs
* Conformer preparation, path sampling, TS optimization, and frequency analysis
* DFT refinement (via Gaussian) and NEB path sampling (via ORCA) and IRC calculations (optional)
* XTB/DFT free energy extraction and **automatic generation of energy diagrams for both xtb- and DFT-level calculations**
* Modular script-based execution (confots\_step0 to step5)
* Thanks to the generality and modularity of ACCeL, it is easy to switch between different external programs (e.g., ORCA, Gaussian, xtb, or job schedulers such as PBS) with minimal adjustments

---

## 📁 Repository Structure

```
confots_step0.py   # Initial conformer processing and input generation
confots_step1.py   # NEB setup, pairwise TS search and preoptimization
confots_step2.py   # Gaussian job execution and resubmission
confots_step3.py   # DFT log analysis and free energy extraction
confots_step4.py   # IRC job generation and execution
confots_step5.py   # IRC trajectory processing and final data output
run_confots.py     # Python-based unified execution script
run_confots.sh     # PBS batch script for HPC environments
template/          # Templates for .gjf/.inp/.qsh files
```

---

## 🚀 Usage

To use ConfoTS, follow these steps:

1. **Create a working directory** for your reaction.
2. **Copy all the `confots_step*.py` scripts**, the `template/` directory, and optionally `run_confots.py` or `run_confots.sh` into this directory.
   You may omit `run_confots.py`/`.sh` if you prefer to run each step manually.
3. **Place your reaction definition file (`*.rxn`)** into the same directory.
4. Run the workflow using either the Python script (`run_confots.py`) or the PBS job script (`run_confots.sh`).

After execution, the workflow will generate a structured set of output files. Below is an overview of key output directories **automatically generated by the workflow** (user-provided inputs such as `template/`, `reactant/`, `product/`, or the `.rxn` file are excluded):

```
000_2d_mols            # 2D molecule representations generated from input
001_3d_structures      # 3D geometries constructed via RDKit
002_splitted_mols      # Individual molecular components parsed from the reaction
003_mapped_candidates  # Atom-mapped candidates for reaction pairing
004_mapped_inputs      # Reaction inputs prepared with mappings and structure data
005_mae_inputs         # Inputs formatted for NEB and energy evaluations
011_reactant           # Selected conformers of the reactant (in XYZ format)
012_product            # Selected conformers of the product (in XYZ format)
021_reactant_sdf       # SDF-formatted conformer set of the reactant
022_product_sdf        # SDF-formatted conformer set of the product
030_solvent            # Solvent definitions (if used)
099_config             # Configuration and control files
100_ff_reapro_cs       # Force-field level optimization: constrained optimization of reactant–product pairs
102_ff_reapro_xyz      # Relaxed XYZ geometries of optimized FF structures
110_emp_reapro_opt     # Initial guess TS structure from reactant–product interpolation
111_emp_rea_xyz        # Coordinates of reactant conformer for NEB input
112_emp_pro_xyz        # Coordinates of product conformer for NEB input
113_rea_pro_data       # Combined metadata of conformer pairs
114_emp_reapro_freq    # FF-level frequency calculations for interpolated structures
120_ff_pair_mini       # Force-field TS preoptimization
120_ff_pair_mini_recalc0–3 # Recalculated preoptimizations (if needed)
121_after_pair_mini    # Results after preoptimization and filtering
122_emp_pair_opt       # Optimized NEB guess structure
123_emp_ts_neb         # NEB calculation results
124_emp_nebts_xyz      # Extracted TS candidates from NEB path
125_emp_ts_freq        # Frequency calculation for TS verification
125_emp_ts_irc_B/F     # IRC backward and forward trajectories
126_emp_ts_data        # Summary of TS validation results
126_emp_ts_xyz         # XYZ geometries of validated TSs
127_emp_ts_freq_analysis # Detailed vibrational analysis
128_emp_irc_analysis   # Energy and connectivity verification via IRC
130_energy_diagram_xtb # Barrier diagram based on xtb energies
201_dft_rea_opt        # DFT optimization of reactant
202_dft_pro_opt        # DFT optimization of product
203_dft_ts_opt         # DFT optimization of TS
300_dft_all_log        # Log files from DFT calculations
301_dft_all_xyz        # Optimized geometries from DFT
310_energy_diagram_dft # Energy profile diagram based on DFT results
311_dft_min_log        # Log of lowest energy structures
312_dft_min_xyz        # XYZ of lowest energy structures
401_irc_forward        # IRC forward trajectory (Gaussian)
402_irc_reverse        # IRC reverse trajectory (Gaussian)
403_irc_forward_all    # Combined forward IRC results
404_irc_reverse_all    # Combined reverse IRC results
501_irc_trj            # IRC trajectory in XYZ format
502_terminal_opt       # Final structure optimization from IRC endpoint
```

---

## 📦 Requirements

* Python 3.9+
* [ACCeL](https://github.com/kfchem/accel) >= 0.3.0
* [acceltools](https://github.com/kfchem/acceltools) >= 0.2.0
* Python libraries: `rdkit`, `matplotlib`
* External software:

  * [ORCA](https://orcaforum.kofo.mpg.de/)
  * [MacroModel](https://www.schrodinger.com/products/macromodel)
  * [xtb](https://github.com/grimme-lab/xtb) (v6+)
  * [Gaussian 16](https://gaussian.com/)
  * [OpenPBS](https://www.openpbs.org/) job scheduler (for HPC cluster submission)

---

## 🧾 Template Directory

The `template/` directory contains default input templates and job submission scripts required for running the ConfoTS workflow. Each file has a dedicated role and can be customized if needed:

* `atm.py`: atomic parameter definitions used in structure analysis.
* `default.ini`: fallback configuration file loaded when no `config.ini` is found.
* `g16_*.gjf`: Gaussian input templates for SP, optimization, TS search, IRC, etc.
* `g16_*.qsh`: PBS batch scripts for submitting Gaussian jobs with various settings.
* `g16_hpc.qsh`, `g16_hpc_nochk.qsh`: Gaussian HPC job scripts (with/without checkpoint files).
* `mm_*.com`, `mm_*.sbc`: MacroModel conformer sampling and optimization inputs.
* `mm.qsh`: PBS batch script for MacroModel jobs.
* `orca_*.inp`: ORCA input files for NEB, IRC, and optimization.
* `orca_*.qsh`: PBS job submission scripts for ORCA.
* `qsb`: Quantum Structure Batch file (legacy or optional use).
* `solvent_key.txt`: list of available solvents and identifiers.
* `xtb_*.qsh`: PBS job submission scripts for XTB frequency and geometry optimization.

These files are referenced internally during each step and may be edited to suit different cluster environments or software versions.

---

## ⚙ Configuration File (`config.ini`)

To customize behavior, place a file named `config.ini` in the same directory where the workflow is executed. This file will be automatically loaded at runtime.

The following are representative options available in the configuration file used by ConfoTS. Each option can be customized to tune the behavior of the workflow.

| Option                                | Default | Description                                                                   |
| ------------------------------------- | ------- | ----------------------------------------------------------------------------- |
| `need_hpc`                            | `True`  | Whether to assume HPC environment (PBS job submission).                       |
| `keep_calc`                           | `True`  | Keep all intermediate calculation folders.                                    |
| `max_mw`                              | `512`   | Maximum molecular weight allowed for species.                                 |
| `xtb_opt`                             | `True`  | Use xtb for initial geometry optimization.                                    |
| `sp_only`                             | `False` | If `True`, only perform single-point energy evaluations.                      |
| `run_irc`                             | `True`  | Perform IRC calculation to verify TS.                                         |
| `irc_all`                             | `False` | Run IRC for all TSs instead of selected ones.                                 |
| `qst_opt`                             | `True`  | Use QST2 optimization for TS localization.                                    |
| `cs_steps`                            | `10000` | Maximum number of steps in conformer sampling.                                |
| `zoom_neb`                            | `False` | Apply image spacing refinement in NEB initialization.                         |
| `nimages`                             | `8`     | Number of NEB images.                                                         |
| `image_distance`                      | `2.0`   | Spacing between NEB images.                                                   |
| `cov_scaling`                         | `1.1`   | Covalent radius scaling factor.                                               |
| `rmsd_limit`                          | `0.1`   | RMSD cutoff for conformer overlap removal.                                    |
| `max_cycle_of_force_mini`             | `10`    | Max number of cycles in FF-level minimization.                                |
| `path_flag`                           | `auto`  | Direction of pairwise path generation.                                        |
| `energy_limit_to_empopt`              | `10.0`  | Max energy threshold for empirical preoptimization.                           |
| `energy_limit_to_neb`                 | `5.0`   | Energy cutoff for launching NEB.                                              |
| `max_limit_to_neb`                    | `64`    | Max number of NEB jobs.                                                       |
| `energy_limit_to_reapro_dft`          | `5.0`   | Energy cutoff for selecting structures for DFT reactant/product optimization. |
| `energy_limit_to_ts_dft`              | `10.0`  | Energy cutoff for DFT-level TS optimization.                                  |
| `max_limit_to_dftopt`                 | `16`    | Max number of DFT optimization jobs.                                          |
| `max_limit_for_local_reapro_in_total` | `128`   | Limit for local reoptimization jobs in total.                                 |
| `use_irc_terminal_for_qst`            | `True`  | Use IRC endpoint structure as guess for QST.                                  |
| `fix_isomeric_ez`                     | `True`  | Maintain E/Z stereochemistry.                                                 |
| `check_chirality`                     | `True`  | Check chirality of conformers.                                                |
| `check_irc_chirality`                 | `True`  | Check chirality before and after IRC.                                         |

Additional advanced options can be customized through dictionary-style entries in the config file:

* `lewis`: manually defined bond rules, e.g., `[[label, atom1, atom2, distance]]`
* `ignored_atoms_in_bond_check`: atom indices to ignore during bond validation, e.g., `{label: [7, 40]}`
* `ignored_symbols_in_bond_check`: element symbols to ignore, e.g., `{label: ["Si"]}`
* `ignored_bonds_in_bond_check`: specific bond pairs to ignore, e.g., `{label: [[5, 6], [54, 3]]}`
* `rxn_bonds`: predefined reacting bond pairs, e.g., `[[label1, label2, idx1, idx2]]`
* `rxn_atoms`: atom mappings between reactant and product structures, e.g., `[[label1, label2, idx]]`
* `ts_labels`: manual TS labeling dictionary, e.g., `{TS_name: label}`
* `mm_constraints`: custom constraints for MacroModel input, e.g., `{"a": [["FXBA", 35, 49, 52, 0, 5000.0, 180.0, 0.0, 0.0]]}`

---

## 📜 License

MIT License
