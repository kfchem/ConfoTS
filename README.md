# ConfoTS

**ConfoTS** is a Python-based automated workflow for reaction barrier estimation and transition state (TS) identification using multiple conformers.
It builds upon [ACCeL](https://github.com/kfchem/accel), which provides flexible support for handling ensembles of molecular conformers, to enable end-to-end TS searches, energy evaluations, and barrier diagram generation.

---

## üß¨ Key Features

- Accepts reaction files (`.rxn`) typically drawn using common chemical drawing tools, and automatically parses, separates, and atom-maps reactant and product structures
- Performs automated transition state searches using NEB (nudged elastic band) for conformer pairs
- Handles conformer generation, pairwise structure construction, TS optimization, and frequency analysis
- Automates external execution of DFT, NEB, and IRC calculations
- Extracts free energies and automatically generates reaction energy diagrams
- Provides modular, script-based execution (from `confots_step0` to `confots_step5`)
- Built on the general and modular framework of ACCeL, allowing easy integration with external tools such as ORCA, Gaussian, xtb, and job schedulers with minimal changes

---

## üìÅ Repository Structure

```
confots_step0.py   # Interpretation of the reaction scheme and generation of input-ready molecular structures
confots_step1.py   # Reaction analysis based on bonding changes, conformer generation, pairwise structure construction, NEB calculations, and semiempirical optimization
confots_step2.py   # DFT job execution and resubmission handling
confots_step3.py   # DFT log parsing, free energy extraction, and IRC job preparation
confots_step4.py   # IRC job execution
confots_step5.py   # IRC trajectory processing and organization
run_confots.py     # Python script for unified execution of all steps
run_confots.sh     # Shell script for unified execution via job scheduler
template/          # Template files for Gaussian, ORCA, and job scripts (.gjf, .inp, .qsh)
```

---

## üöÄ Usage

To use ConfoTS, follow these steps:

1. **Create a working directory** for your reaction.
2. **Copy all the `confots_step*.py` scripts**, the `template/` directory, and optionally `run_confots.py` or `run_confots.sh` into this directory.
   You may omit `run_confots.py`/`.sh` if you prefer to run each step manually.
3. **Place your reaction definition file (`*.rxn`)** into the same directory.
4. Run the workflow using either the Python script (`run_confots.py`) or the PBS job script (`run_confots.sh`).

After execution, the workflow will generate a structured set of output files. Below is an overview of key output directories **automatically generated by the workflow** (user-provided inputs such as `template/` are excluded):

```
000_2d_mols             # 2D molecular representations generated from input
001_3d_structures       # 3D geometries generated using RDKit
002_splitted_mols       # Individual molecular components parsed from the reaction scheme
003_mapped_candidates   # Atom-mapped candidates for reaction pairing
004_mapped_inputs       # Atom-mapped structures of reactants and products
005_mae_inputs          # Structures prepared for Macromodel input

011_reactant            # Structures of reactants
012_product             # Structures of products
021_reactant_sdf        # SDF format structures of reactants
022_product_sdf         # SDF format structures of products
030_solvent             # Solvent definitions
099_config              # Configuration and control files

100_ff_reapro_cs        # Job dir for force-field conformer generation
102_ff_reapro_xyz       # Conformer structures generated with force field in XYZ format

110_emp_reapro_opt      # Job dir for semiempirical optimization
111_emp_rea_xyz         # Coordinates of reactant conformers (semiempirical)
112_emp_pro_xyz         # Coordinates of product conformers (semiempirical)
113_rea_pro_data        # Combined metadata of reactant and product conformers
114_emp_reapro_freq     # Job dir for semiempirical frequency analysis

120_ff_pair_mini        # Job dir for force-field minimization of converted structures
120_ff_pair_mini_recalc # Job dir for restricted force-field minimization
121_after_pair_mini     # Minimized structures after conversion between reactant and product

122_emp_pair_opt        # Job dir for semiempirical pair optimization
123_emp_ts_neb          # Job dir for NEB calculation
124_emp_nebts_xyz       # Transition state candidates extracted from NEB paths
125_emp_ts_freq         # Job dir for TS frequency analysis
125_emp_ts_irc_B/F      # Job dir for IRC calculation
126_emp_ts_data         # Summary of validated transition states (semiempirical)
126_emp_ts_xyz          # XYZ geometries of validated transition states
127_emp_ts_freq_analysis # Detailed vibrational analysis of transition states
128_emp_irc_analysis    # IRC trajectory analysis (semiempirical)

130_energy_diagram_xtb  # Energy diagram generated from xTB calculations

201_dft_rea_opt         # Job dir for DFT optimization of reactants
202_dft_pro_opt         # Job dir for DFT optimization of products
203_dft_ts_opt          # Job dir for DFT optimization of transition states

300_dft_all_log         # Log files from DFT calculations
301_dft_all_xyz         # Optimized structures from DFT in XYZ format

310_energy_diagram_dft  # Energy diagram based on DFT results
311_dft_min_log         # Log files of lowest-energy structures
312_dft_min_xyz         # XYZ geometries of lowest-energy structures

401_irc_forward         # Job dir for forward IRC calculation
402_irc_reverse         # Job dir for reverse IRC calculation
403_irc_forward_all     # Job dir for forward IRC (all conformers)
404_irc_reverse_all     # Job dir for reverse IRC (all conformers)

501_irc_trj             # IRC trajectories in XYZ format
502_terminal_opt        # Final structure optimization from IRC endpoints

```

---

## üì¶ Requirements

- Python 3.9 or higher
- [ACCeL](https://github.com/kfchem/accel) version 0.3.0 or later
- [acceltools](https://github.com/kfchem/acceltools) version 0.2.0 or later
- Python libraries: `rdkit`, `matplotlib`

- External software:
  - [ORCA](https://orcaforum.kofo.mpg.de/) for NEB calculations
  - [MacroModel](https://www.schrodinger.com/products/macromodel) for conformer generation
  - [xtb](https://github.com/grimme-lab/xtb) for NEB calculations and pre-DFT optimization
  - [Gaussian 16](https://gaussian.com/) for DFT calculations
  - [OpenPBS](https://www.openpbs.org/) for job scheduling
  - [RDKit](https://www.rdkit.org/) for initial 3D structure generation

---

## üßæ Template Directory

The `template/` directory contains default input templates and job submission scripts required for running the ConfoTS workflow. Each file has a dedicated role and can be customized if needed:

- `default.ini`: fallback configuration file loaded when no `config.ini` is found.
- `g16_*.gjf`: Gaussian input templates for SP, optimization, TS search, IRC, etc.
- `g16.qsh`: Scripts for submitting Gaussian jobs with various settings.
- `mm_*.com`, `mm_*.sbc`: MacroModel conformer sampling and optimization inputs.
- `mm.qsh`: Script for MacroModel jobs.
- `orca_*.inp`: ORCA input files for NEB, IRC, and optimization.
- `orca_*.qsh`: PBS job submission scripts for ORCA.
- `xtb_*.qsh`: PBS job submission scripts for XTB frequency and geometry optimization.

These files are referenced internally during each step and may be edited to suit different cluster environments or software versions.

---

## ‚öô Configuration File (`config.ini`)

To customize behavior, place a file named `config.ini` in the same directory where the workflow is executed. This file will be automatically loaded at runtime.

The following are representative options available in the configuration file used by ConfoTS. Each option can be customized to tune the behavior of the workflow.

| Option                       | Default | Description                                                                                                        |
| ---------------------------- | ------- | ------------------------------------------------------------------------------------------------------------------ |
| `max_mw`                     | `512`   | Maximum molecular weight allowed for each species.                                                                 |
| `lewis_distance_scaling`     | `0.9`   | Distance scaling factor (relative to van der Waals radii) used to infer Lewis bonding.                             |
| `lewis_force_constant`       | `1000`  | Force constant applied to enforce Lewis bonding patterns.                                                          |
| `console_show`               | `False` | Show runtime messages on the console.                                                                              |
| `helper_script`              | `True`  | Place helper scripts into DFT calculation directories.                                                             |
| `xtb_opt`                    | `True`  | Use xtb directly for structure optimization (not via ORCA).                                                        |
| `cs_steps`                   | `10000` | Maximum number of steps for conformer sampling.                                                                    |
| `calc_symm_for_all_ts`       | `False` | Perform symmetry calculations for RMSD comparison for all conformers. If `False`, only the representative is used. |
| `prep_opt`                   | `False` | Perform constrained pre-optimization (with fixed reactive atoms) before empirical optimization.                    |
| `path_flag`                  | `auto`  | Direction for generating reaction paths: `auto`, `both`, `reactant_to_product`, or `product_to_reactant`.          |
| `zoom_neb`                   | `False` | Apply ZOOM-NEB to refine initial path sampling.                                                                    |
| `nimages`                    | `8`     | Number of images to use in NEB calculations.                                                                       |
| `image_distance`             | `2`     | Target spacing between NEB images.                                                                                 |
| `cov_scaling`                | `1.1`   | Scaling factor applied to covalent radii when checking bonding.                                                    |
| `rmsd_limit`                 | `0.1`   | RMSD threshold for removing redundant conformers.                                                                  |
| `max_cycle_of_force_mini`    | `10`    | Maximum number of force-field minimization cycles.                                                                 |
| `energy_limit_to_empopt`     | `10.0`  | Energy threshold (kcal/mol) for including structures in empirical preoptimization.                                 |
| `energy_limit_to_neb`        | `5.0`   | Energy cutoff for launching NEB calculations.                                                                      |
| `max_limit_to_neb`           | `64`    | Maximum number of NEB calculations to run.                                                                         |
| `qst_opt`                    | `True`  | Use QST3 optimization to refine TS structures at the DFT level.                                                    |
| `use_ci_xyz`                 | `False` | Use the climbing image structure from NEB-CI for DFT TS optimization.                                              |
| `run_irc`                    | `True`  | Perform IRC calculations to validate TS connectivity at the DFT level.                                             |
| `irc_all`                    | `False` | Run IRC for all conformers; if `False`, only for the lowest-energy one.                                            |
| `irc_test`                   | `True`  | Run IRC pre-check before DFT calculations to filter valid conformers.                                              |
| `use_irc_terminal_for_qst`   | `True`  | Use the final IRC structure for QST TS refinement.                                                                 |
| `energy_limit_to_reapro_dft` | `5.0`   | Energy cutoff for selecting structures for DFT optimization of reactants/products.                                 |
| `energy_limit_to_ts_dft`     | `10.0`  | Energy cutoff for selecting structures for DFT TS optimization.                                                    |
| `max_limit_to_dftopt`        | `16`    | Maximum number of DFT optimization jobs.                                                                           |
| `sp_only`                    | `False` | If `True`, skip DFT geometry optimizations and only run single-point calculations.                                 |
| `fix_isomeric_ez`            | `True`  | Whether to fix E/Z configuration (e.g., in imines or oximes) when generating reactant‚Äìproduct conformer pairs.     |
| `check_chirality`            | `True`  | Check whether generated conformers maintain chirality.                                                             |
| `check_irc_chirality`        | `True`  | Check chirality consistency before and after IRC.                                                                  |
| `additional_valid_range`     | `1`     | Tolerance range for vibrational center assignment validation.                                                      |
| `acceptable_invalid_atoms`   | `1`     | Maximum number of atoms allowed outside the valid vibrational range.                                               |

Additional advanced options can be customized through dictionary-style entries in the config file:

- `lewis`: manually defined bond rules, e.g., `[[label, atom1, atom2, distance]]`
- `ignored_atoms_in_bond_check`: atom indices to ignore during bond validation, e.g., `{label: [7, 40]}`
- `ignored_symbols_in_bond_check`: element symbols to ignore, e.g., `{label: ["Si"]}`
- `ignored_bonds_in_bond_check`: specific bond pairs to ignore, e.g., `{label: [[5, 6], [54, 3]]}`
- `rxn_bonds`: predefined reacting bond pairs, e.g., `[[label1, label2, idx1, idx2]]`
- `rxn_atoms`: atom mappings between reactant and product structures, e.g., `[[label1, label2, idx]]`
- `ts_labels`: manual TS labeling dictionary, e.g., `{TS_name: label}`
- `mm_constraints`: custom constraints for MacroModel input, e.g., `{"a": [["FXBA", 35, 49, 52, 0, 5000.0, 180.0, 0.0, 0.0]]}`

---

## üìú License

MIT License

---

## üóÇÔ∏è Project Information

- **Repository**: [github.com/kfchem/confots](https://github.com/kfchem/confots)
- **Author**: Keisuke Fukaya
- **License**: MIT
- **Python Compatibility**: Python 3.9+
